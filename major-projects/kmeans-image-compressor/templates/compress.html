{% extends "layout.html" %}
{% set title = "Compress Image | K-Means" %}
{% set active = "compress" %}

{% block content %}

<style>
    /*--- NEW ACCENT COLOR DEFINITIONS ---*/
    :root {
        --accent-color: #0f7d63;
        --accent-color-rgb: 15, 125, 99; /* For rgba opacity backgrounds */
        --accent-color-hover: #0a5c49; /* Slightly darker for button hover states */
    }

    /* Custom text utility class */
    .text-accent {
        color: var(--accent-color) !important;
    }

    /* Custom button utility class to replace btn-warning */
    .btn-accent {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
    }
    .btn-accent:hover, .btn-accent:focus, .btn-accent:active {
        background-color: var(--accent-color-hover);
        border-color: var(--accent-color-hover);
        color: white;
    }

    /*--- CUSTOM DRAG & DROP STYLES ---*/
    .upload-area {
        border: 2px dashed #495057; /* Dark grey dashed border */
        border-radius: 10px;
        background-color: rgba(255, 255, 255, 0.02);
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .upload-area:hover {
        background-color: rgba(255, 255, 255, 0.05);
        /* UPDATED ACCENT COLOR */
        border-color: var(--accent-color);
    }

    .upload-area.dragover {
        /* UPDATED ACCENT COLOR RGB with opacity */
        background-color: rgba(var(--accent-color-rgb), 0.1);
        border-color: var(--accent-color);
        transform: scale(1.01);
    }

    .upload-icon {
        font-size: 3rem;
        color: #6c757d;
        transition: color 0.3s;
    }

    .upload-area:hover .upload-icon {
        /* UPDATED ACCENT COLOR */
        color: var(--accent-color);
    }
</style>

<section class="text-center mb-5">
    <h2 style="letter-spacing: 0.12em; text-transform: uppercase;">
        Compress Image
    </h2>
    <p class="text-accent">
        Manual control or intelligent auto-compression using
        <b>unsupervised learning + information theory</b>.
    </p>
</section>

<section class="card-dark p-4 mb-5">
    <form method="POST" enctype="multipart/form-data" action="">

        <div class="mb-4">
            <label class="form-label">Select Image</label>
            
            <div class="upload-area p-5 text-center" id="dropZone">
                <div id="dropContent">
                    <div class="upload-icon mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-cloud-arrow-up" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2z"/>
                            <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.633 14.533 11 12.68 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z"/>
                        </svg>
                    </div>
                    <h5 class="text-muted">Drag & Drop image here</h5>
                    <p class="small text-muted mb-0">or click to browse files</p>
                </div>

                <div id="filePreview" class="d-none">
                    <h5 class="text-accent mb-1" id="fileName">filename.jpg</h5>
                    <p class="small text-muted">Ready to compress!</p>
                    <button type="button" class="btn btn-sm btn-outline-light mt-2" id="changeFileBtn">Change File</button>
                </div>

                <input
                    type="file"
                    id="realFileInput"
                    name="image"
                    accept=".jpg,.jpeg,.png"
                    style="display: none;"
                    required
                >
            </div>
        </div>

        <div class="mb-3">
            <label for="kRange" class="form-label">
                Number of Colors (K): <b id="kValue">{{ k }}</b>
            </label>
            <input
                type="range"
                class="form-range"
                name="k"
                id="kRange"
                min="2"
                max="64"
                step="2"
                value="{{ k }}"
                {% if auto_k %}disabled{% endif %}
                oninput="document.getElementById('kValue').innerText = this.value"
            >
        </div>

        <div class="form-check mb-4">
            <input
                class="form-check-input"
                type="checkbox"
                name="auto_k"
                id="autoK"
                {% if auto_k %}checked{% endif %}
                onchange="document.getElementById('kRange').disabled = this.checked;"
            >
            <label class="form-check-label" for="autoK">
                Automatically choose optimal K (entropy-based)
            </label>
        </div>

        <button type="submit" class="btn btn-accent px-4">
            Compress Image
        </button>

    </form>
</section>

{% if output_image %}
<section>
    <h4 class="mb-3">Compressed Result</h4>
    <div class="row g-4 align-items-start">
        <div class="col-md-7">
            <div class="card-dark p-3 text-center">
                <img
                    src="{{ url_for('static', filename=output_image) }}?v={{ stats.compressed_size_kb if stats else 1 }}"
                    class="img-fluid rounded mb-3"
                    alt="Compressed Image"
                    style="max-height: 500px; object-fit: contain;"
                >
                <a href="{{ url_for('static', filename=output_image) }}" download class="btn btn-success w-100">
                    ⬇️ Save Compressed Image
                </a>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card-dark p-4">
                <h6 class="mb-3 border-bottom pb-2">Compression Stats</h6>
                {% if stats %}
                <ul class="list-unstyled text-muted mb-0">
                    <li class="mb-2"><strong>K used:</strong> {{ stats.k_used }}</li>
                    <li class="mb-2"><strong>Mode:</strong> {{ "Auto (Entropy)" if stats.auto_k else "Manual" }}</li>
                    <li class="mb-2"><strong>Entropy Score:</strong> {{ stats.entropy }}</li>
                    {% if stats.jpeg_quality %}
                        <li class="mb-2"><strong>JPEG Quality:</strong> {{ stats.jpeg_quality }}</li>
                    {% endif %}
                    <hr class="border-secondary my-3">
                    <li class="mb-1">Original size: <span class="text-white">{{ stats.original_size_kb }} KB</span></li>
                    <li class="mb-1">Compressed size: <span class="text-success">{{ stats.compressed_size_kb }} KB</span></li>
                    <li class="mb-1">Reduction: <strong class="text-accent">{{ stats.reduction_percent }}%</strong></li>
                </ul>
                {% else %}
                    <p class="text-danger">Statistics unavailable.</p>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endif %}

<script>
    const dropZone = document.getElementById('dropZone');
    const realInput = document.getElementById('realFileInput');
    const dropContent = document.getElementById('dropContent');
    const filePreview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const changeFileBtn = document.getElementById('changeFileBtn');

    // 1. Handle Click
    dropZone.addEventListener('click', () => realInput.click());

    // 2. Stop bubble up on button click
    changeFileBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Don't trigger the dropZone click again
        realInput.click();
    });

    // 3. Handle File Selection (via click)
    realInput.addEventListener('change', () => {
        if (realInput.files.length > 0) {
            showFile(realInput.files[0]);
        }
    });

    // 4. Handle Drag Events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // Visual feedback for drag
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
    });

    // 5. Handle Drop
    dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
            realInput.files = files; // Assign dropped files to hidden input
            showFile(files[0]);
        }
    });

    // Update UI function
    function showFile(file) {
        dropContent.classList.add('d-none');
        filePreview.classList.remove('d-none');
        fileName.innerText = file.name;
    }
</script>

{% endblock %}