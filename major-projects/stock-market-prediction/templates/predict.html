{% extends "layout.html" %}
{% set title = "Predict Stock Price" %}
{% set active = "predict" %}

{% block content %}

<style>
    /* --- Glassy cards (same vibe as stats page, slightly brighter) --- */
    .glass-card {
        background: radial-gradient(circle at top left, #1f1f1f, #141414 60%);
        border-radius: 1rem;
        padding: 1.3rem 1.4rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow:
            inset 0 0 0.5px rgba(255, 255, 255, 0.16),
            0 14px 40px rgba(0, 0, 0, 0.75),
            0 0 25px rgba(219, 164, 0, 0.06);
        transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }

    .glass-card:hover {
        border-color: #dba400;
        box-shadow:
            inset 0 0 0.5px rgba(255, 255, 255, 0.25),
            0 18px 46px rgba(0, 0, 0, 0.85),
            0 0 32px rgba(219, 164, 0, 0.16);
        transform: translateY(-2px);
    }

    /* --- Form controls --- */
    .predict-form-control,
    .predict-form-select {
        background-color: #181818;
        border-color: #444;
        color: #ffffff;
        border-radius: 0.7rem;
        font-size: 0.9rem;
    }

    .predict-form-control::placeholder {
        color: #777;
    }

    .predict-form-control:focus,
    .predict-form-select:focus {
        border-color: #dba400;
        box-shadow: 0 0 0 0.15rem rgba(219, 164, 0, 0.25);
        background-color: #181818;
        color: #ffffff;
    }

    .predict-form-control:hover,
    .predict-form-select:hover {
        border-color: #dba400;
    }

    /* --- Buttons --- */
    .btn-gold-pill {
        background-color: #dba400;
        border-color: #dba400;
        color: #181818;
        font-weight: 600;
        border-radius: 999px;
    }

    .btn-gold-pill:hover {
        border-color: #f5c845;
        background-color: #f5c845;
        color: #181818;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.7);
    }

    .btn-outline-gold-pill {
        background-color: #181818;
        border-color: #dba400;
        color: #dba400;
        font-weight: 600;
        border-radius: 999px;
    }

    .btn-outline-gold-pill:hover {
        background-color: #231a07;
        border-color: #f5c845;
        color: #f5c845;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.7);
    }

    .btn-outline-gold-pill.disabled-btn,
    .btn-outline-gold-pill:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
        border-color: #555;
        color: #777;
        background-color: #151515;
    }

    .nav-pill-group .btn {
        font-size: 0.8rem;
        border-radius: 999px;
        padding-inline: 1.1rem;
    }

    /* --- Instruction list --- */
    .ticker-guidelines-title {
        font-size: 0.8rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: #9e9e9e;
        margin-bottom: 0.4rem;
    }

    .ticker-guidelines-list {
        font-size: 0.8rem;
        color: #c7c7c7;
        padding-left: 1.1rem;
        margin-bottom: 0.4rem;
    }

    .ticker-guidelines-list li+li {
        margin-top: 0.15rem;
    }

    .ticker-example-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.75rem;
        padding: 0.15rem 0.55rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.08);
        margin-right: 0.25rem;
        margin-bottom: 0.2rem;
    }

    .ticker-example-pill code {
        font-size: 0.75rem;
        color: #f5f5f5;
    }

    .ticker-doc-link {
        font-size: 0.78rem;
    }

    .ticker-doc-link a {
        color: #dba400;
        text-decoration: none;
    }

    .ticker-doc-link a:hover {
        text-decoration: underline;
    }
</style>

<!-- HERO / TITLE -->
<section class="center-box d-flex justify-content-center align-items-center" data-aos="fade-up">
    <div class="text-center">
        <h1 class="mb-2" style="font-size: 1.4rem; letter-spacing: 0.08em; text-transform: uppercase;">
            Predict a Stock Price
        </h1>
        <p class="small-muted mb-0">
            Enter a ticker symbol and select how much recent history to use.
        </p>
    </div>
</section>

<!-- FORM + RESULT -->
<section class="pb-5">
    <div class="container">
        <!-- Form + Ticker Instructions -->
        <div class="row justify-content-center mb-4">
            <div class="col-12 col-lg-7 mb-3 mb-lg-0" data-aos="fade-right" data-aos-delay="100">
                <form method="POST" class="glass-card">
                    <div class="mb-3">
                        <label for="ticker" class="form-label small-muted">Ticker Symbol</label>
                        <input type="text" class="form-control predict-form-control" id="ticker" name="ticker"
                            placeholder="e.g. AAPL, MSFT, TSLA, RELIANCE.NS" value="{{ ticker or '' }}">
                    </div>

                    <div class="mb-3">
                        <label for="period" class="form-label small-muted">Recent History Period</label>
                        <select class="form-select predict-form-select" id="period" name="period">
                            {% set options = {
                            '1mo': 'Last 1 month',
                            '3mo': 'Last 3 months',
                            '6mo': 'Last 6 months',
                            '1y': 'Last 1 year'
                            } %}
                            {% for value, label in options.items() %}
                            <option value="{{ value }}" {% if selected_period==value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="submit" name="action" value="run" class="btn btn-gold-pill px-4">
                            Run Prediction
                        </button>
                    </div>

                    {% if error %}
                    <p class="mt-3 small-muted" style="color:#ff5252;">{{ error }}</p>
                    {% endif %}
                </form>
            </div>

            <!-- Instructions card -->
            <div class="col-12 col-lg-5" data-aos="fade-left" data-aos-delay="200">
                <div class="glass-card h-100">
                    <div class="ticker-guidelines-title">
                        How to enter ticker symbols
                    </div>

                    <ul class="ticker-guidelines-list">
                        <li>US stocks: plain ticker, e.g. <code>AAPL</code>, <code>MSFT</code>, <code>TSLA</code>.</li>
                        <li>Indian NSE stocks: append <code>.NS</code>, e.g. <code>RELIANCE.NS</code>,
                            <code>TATASTEEL.NS</code>.
                        </li>
                        <li>Indian BSE stocks: append <code>.BO</code>, e.g. <code>SBIN.BO</code>.</li>
                        <li>ETFs / indices often use their Yahoo Finance symbol (e.g. <code>QQQ</code>,
                            <code>NIFTYBEES.NS</code>).
                        </li>
                        <li>Make sure there are no spaces: use <code>INFY.NS</code>, not <code>INFY .NS</code>.</li>
                    </ul>

                    <div class="mb-2">
                        <span class="ticker-example-pill">
                            <span class="small-muted">US</span>
                            <code>AAPL</code>
                        </span>
                        <span class="ticker-example-pill">
                            <span class="small-muted">NSE</span>
                            <code>RELIANCE.NS</code>
                        </span>
                        <span class="ticker-example-pill">
                            <span class="small-muted">BSE</span>
                            <code>SBIN.BO</code>
                        </span>
                    </div>

                    <p class="ticker-doc-link small-muted mb-0">
                        Tickers are resolved using Yahoo Finance symbols via <code>yfinance</code>.
                        You can look up valid symbols and suffixes in the
                        <a href="https://ranaroussi.github.io/yfinance/" target="_blank" rel="noopener">
                            yfinance documentation
                        </a>.
                    </p>
                </div>
            </div>
        </div>

        <!-- Prediction Result -->
        {% if insights %}
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8" data-aos="zoom-in-up" data-aos-delay="100">
                <div class="glass-card d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <div class="stock-ticker">{{ insights.ticker }}</div>
                            <div class="small-muted">
                                Trend:
                                <span class="trend-pill
                                    {% if insights.trend_label == 'bullish' %}trend-bullish
                                    {% elif insights.trend_label == 'bearish' %}trend-bearish
                                    {% else %}trend-neutral{% endif %}">
                                    {{ insights.trend_label | capitalize }}
                                </span>
                            </div>
                            {% if selected_period %}
                            <div class="small-muted mt-1">
                                Based on {{ options[selected_period] if options and selected_period in options else
                                selected_period }}
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            {% set dir = 'flat' %}
                            {% if insights.expected_change_pct > 0 %}
                            {% set dir = 'up' %}
                            {% elif insights.expected_change_pct < 0 %} {% set dir='down' %} {% endif %} {% if dir=='up'
                                %} <span class="direction-badge direction-up">▲ Up</span>
                                {% elif dir == 'down' %}
                                <span class="direction-badge direction-down">▼ Down</span>
                                {% else %}
                                <span class="direction-badge direction-flat">▬ Flat</span>
                                {% endif %}
                        </div>
                    </div>

                    <div class="mt-3 mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="small-muted">Last Close</span>
                            <span class="stock-price">${{ insights.last_close | round(2) }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="small-muted">Predicted Next Close</span>
                            <span class="stock-price">${{ insights.predicted_next_close | round(2) }}</span>
                        </div>
                    </div>

                    <div class="row gy-2">
                        <div class="col-12 col-md-4">
                            <div class="small-muted">Expected Move</div>
                            <div>
                                {{ insights.expected_change_abs | round(2) }} USD
                            </div>
                            <div class="small-muted">
                                {{ insights.expected_change_pct | round(2) }}%
                            </div>
                        </div>

                        <div class="col-12 col-md-4">
                            <div class="small-muted">Moving Averages</div>
                            <div>MA 7d: {{ insights.ma_7 | default('N/A') | round(2) if insights.ma_7 is not none else
                                'N/A' }}</div>
                            <div>MA 30d: {{ insights.ma_30 | default('N/A') | round(2) if insights.ma_30 is not none
                                else 'N/A' }}</div>
                            <div>MA 90d: {{ insights.ma_90 | default('N/A') | round(2) if insights.ma_90 is not none
                                else 'N/A' }}</div>
                        </div>

                        <div class="col-12 col-md-4">
                            <div class="small-muted">Volatility & Position</div>
                            <div>
                                Volatility (30d):
                                {{ insights.daily_volatility_30d_pct | round(2) if insights.daily_volatility_30d_pct is
                                not none else 'N/A' }}%
                            </div>
                            <div>
                                vs 30d avg:
                                {{ insights.position_vs_30d_pct | round(2) if insights.position_vs_30d_pct is not none
                                else 'N/A' }}%
                            </div>
                        </div>
                    </div>

                    <p class="small-muted mt-3 mb-0">
                        These are model-based estimates using historical prices only and are not financial advice.
                    </p>

                    {% if log_message %}
                    <p class="small-muted mt-2 mb-0" style="color:#dba400;">
                        {{ log_message }}
                    </p>
                    {% endif %}
                </div>

                <!-- Log this prediction button + post-log actions -->
                <form method="POST" class="mt-3 text-end">
                    <input type="hidden" name="ticker" value="{{ insights.ticker }}">
                    <input type="hidden" name="period" value="{{ selected_period }}">

                    <button type="submit" name="action" value="log"
                        class="btn btn-outline-gold-pill px-4 save-log-btn {% if log_message %}disabled-btn{% endif %}"
                        {% if log_message %}disabled aria-disabled="true" {% endif %}>
                        Save this prediction to logs
                    </button>

                    {% if log_message %}
                    <div class="mt-3 nav-pill-group d-flex flex-wrap gap-2 justify-content-end">
                        <a href="/" class="btn btn-outline-gold-pill">Home</a>
                        <a href="/logs" class="btn btn-outline-gold-pill">View Logs</a>
                        <a href="/predict" class="btn btn-gold-pill">Predict Again</a>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</section>

{% endblock %}