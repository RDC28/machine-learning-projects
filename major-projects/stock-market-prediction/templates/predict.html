{% extends "layout.html" %}
{% set title = "Predict Stock Price" %}
{% set active = "predict" %}

{% block content %}

<!-- HERO / TITLE -->
<section class="center-box d-flex justify-content-center align-items-center">
    <div class="text-center">
        <h1 class="mb-2" style="font-size: 1.4rem; letter-spacing: 0.08em; text-transform: uppercase;">
            Predict a Stock Price
        </h1>
        <p class="small-muted mb-0">
            Enter a ticker symbol and select how much recent history to use.
        </p>
    </div>
</section>

<!-- FORM + RESULT -->
<section class="pb-5">
    <div class="container">
        <!-- Form -->
        <div class="row justify-content-center mb-4">
            <div class="col-12 col-md-8 col-lg-6">
                <form method="POST" class="p-3 p-md-4 stock-card">
                    <div class="mb-3">
                        <label for="ticker" class="form-label small-muted">Ticker Symbol</label>
                        <input type="text"
                               class="form-control"
                               id="ticker"
                               name="ticker"
                               placeholder="e.g. AAPL, MSFT, TSLA, RELIANCE.NS"
                               value="{{ ticker or '' }}"
                               style="background-color:#181818; border-color:#444; color:#fff;">
                    </div>

                    <div class="mb-3">
                        <label for="period" class="form-label small-muted">Recent History Period</label>
                        <select class="form-select"
                                id="period"
                                name="period"
                                style="background-color:#181818; border-color:#444; color:#fff;">
                            {% set options = {
                                '1mo': 'Last 1 month',
                                '3mo': 'Last 3 months',
                                '6mo': 'Last 6 months',
                                '1y': 'Last 1 year'
                            } %}
                            {% for value, label in options.items() %}
                            <option value="{{ value }}"
                                {% if selected_period == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="submit"
                                name="action"
                                value="run"
                                class="btn px-4"
                                style="background-color:#dba400; border-color:#dba400; color:#181818; font-weight:600; border-radius:999px;">
                            Run Prediction
                        </button>
                    </div>

                    {% if error %}
                    <p class="mt-3 small-muted" style="color:#ff5252;">{{ error }}</p>
                    {% endif %}
                </form>
            </div>
        </div>

        <!-- Prediction Result -->
        {% if insights %}
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">
                <div class="stock-card d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <div class="stock-ticker">{{ insights.ticker }}</div>
                            <div class="small-muted">
                                Trend:
                                <span class="trend-pill
                                    {% if insights.trend_label == 'bullish' %}trend-bullish
                                    {% elif insights.trend_label == 'bearish' %}trend-bearish
                                    {% else %}trend-neutral{% endif %}">
                                    {{ insights.trend_label | capitalize }}
                                </span>
                            </div>
                            {% if selected_period %}
                            <div class="small-muted mt-1">
                                Based on {{ options[selected_period] if options and selected_period in options else selected_period }}
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            {% set dir = 'flat' %}
                            {% if insights.expected_change_pct > 0 %}
                                {% set dir = 'up' %}
                            {% elif insights.expected_change_pct < 0 %}
                                {% set dir = 'down' %}
                            {% endif %}

                            {% if dir == 'up' %}
                            <span class="direction-badge direction-up">▲ Up</span>
                            {% elif dir == 'down' %}
                            <span class="direction-badge direction-down">▼ Down</span>
                            {% else %}
                            <span class="direction-badge direction-flat">▬ Flat</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mt-3 mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="small-muted">Last Close</span>
                            <span class="stock-price">${{ insights.last_close | round(2) }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="small-muted">Predicted Next Close</span>
                            <span class="stock-price">${{ insights.predicted_next_close | round(2) }}</span>
                        </div>
                    </div>

                    <div class="row gy-2">
                        <div class="col-12 col-md-4">
                            <div class="small-muted">Expected Move</div>
                            <div>
                                {{ insights.expected_change_abs | round(2) }} USD
                            </div>
                            <div class="small-muted">
                                {{ insights.expected_change_pct | round(2) }}%
                            </div>
                        </div>

                        <div class="col-12 col-md-4">
                            <div class="small-muted">Moving Averages</div>
                            <div>MA 7d: {{ insights.ma_7 | default('N/A') | round(2) if insights.ma_7 is not none else 'N/A' }}</div>
                            <div>MA 30d: {{ insights.ma_30 | default('N/A') | round(2) if insights.ma_30 is not none else 'N/A' }}</div>
                            <div>MA 90d: {{ insights.ma_90 | default('N/A') | round(2) if insights.ma_90 is not none else 'N/A' }}</div>
                        </div>

                        <div class="col-12 col-md-4">
                            <div class="small-muted">Volatility & Position</div>
                            <div>
                                Volatility (30d):
                                {{ insights.daily_volatility_30d_pct | round(2) if insights.daily_volatility_30d_pct is not none else 'N/A' }}%
                            </div>
                            <div>
                                vs 30d avg:
                                {{ insights.position_vs_30d_pct | round(2) if insights.position_vs_30d_pct is not none else 'N/A' }}%
                            </div>
                        </div>
                    </div>

                    <p class="small-muted mt-3 mb-0">
                        These are model-based estimates using historical prices only and are not financial advice.
                    </p>

                    {% if log_message %}
                    <p class="small-muted mt-2 mb-0" style="color:#dba400;">
                        {{ log_message }}
                    </p>
                    {% endif %}
                </div>

                <!-- Log this prediction button -->
                <form method="POST" class="mt-3 text-end">
                    <input type="hidden" name="ticker" value="{{ insights.ticker }}">
                    <input type="hidden" name="period" value="{{ selected_period }}">
                    <button type="submit"
                            name="action"
                            value="log"
                            class="btn px-4"
                            style="background-color:#181818; border-color:#dba400; color:#dba400; font-weight:600; border-radius:999px;">
                        Save this prediction to logs
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</section>

{% endblock %}
